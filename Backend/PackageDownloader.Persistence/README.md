# PackageDownloader.Persistence

Слой персистентности для хранения и управления скачанными пакетами.

## CachedPackagesStorageService

Сервис для временного хранения путей к архивам с пакетами с автоматической очисткой.

### Особенности

- **Временное хранение**: Пути к архивам кэшируются на 60 минут
- **Автоматическое удаление**: Файлы автоматически удаляются из файловой системы при истечении времени жизни кэша
- **Логирование**: Записывает информацию об удалении файлов и возможных ошибках
- **Безопасность**: Ошибки при удалении не прерывают работу приложения

### Жизненный цикл архива

1. **Создание**: Скачанный архив сохраняется во временную директорию
2. **Кэширование**: Путь к архиву кэшируется с уникальным GUID на 60 минут
3. **Доступ**: Клиент может скачать файл по GUID в течение 60 минут
4. **Удаление**: По истечении 60 минут:
   - Запись в кэше удаляется
   - Срабатывает callback `PostEvictionCallback`
   - Файл удаляется из файловой системы
   - Событие логируется

### Пример использования

```csharp
// Регистрация в DI
services.AddTransient<IPackagesStorageService, CachedPackagesStorageService>();
services.AddMemoryCache();

// Сохранение пути к архиву
var archiveId = _storageService.SetPackagesArchivePath("/tmp/package.tar.gz");

// Получение пути по ID (в течение 60 минут)
var path = _storageService.GetPackagesArchivePath(archiveId);

// После 60 минут:
// - path будет null
// - файл /tmp/package.tar.gz будет удален
```

### Логирование

Сервис использует `ILogger<CachedPackagesStorageService>` для записи:

- **Information**: Успешное удаление файла с указанием причины
- **Error**: Ошибки при попытке удаления файла
- **Debug**: Информация о кэшировании новых архивов

### Обработка ошибок

Ошибки при удалении файлов (например, файл занят другим процессом) логируются, но не прерывают работу приложения. Это предотвращает сбои при автоматической очистке.

### Причины удаления кэша

`PostEvictionCallback` срабатывает при следующих событиях:

- **Expired**: Истекло время жизни (60 минут) - файл удаляется
- **Removed**: Запись явно удалена из кэша - файл удаляется
- **Replaced**: Запись заменена новой - файл удаляется
- **Capacity**: Достигнут лимит памяти кэша - файл удаляется

Во всех случаях файл удаляется, что гарантирует освобождение дискового пространства.
